<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abdelrahman's Life OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        work: { 500: '#4f46e5', 600: '#4338ca', 200: '#c7d2fe', 100: '#e0e7ff', 50: '#eef2ff', 900: '#312e81' },
                        home: { 500: '#10b981', 600: '#059669', 200: '#a7f3d0', 100: '#d1fae5', 50: '#ecfdf5', 900: '#064e3b' },
                        personal: { 500: '#a855f7', 600: '#9333ea', 200: '#e9d5ff', 100: '#f3e8ff', 50: '#faf5ff', 900: '#581c87' },
                        brand: { 900: '#111827' },
                        ksa: { 500: '#15803d', 50: '#f0fdf4', 100: '#dcfce7' },
                        eg: { 500: '#ce1126', 50: '#fef2f2', 100: '#fee2e2' },
                        learning: { 500: '#3b82f6', 600: '#2563eb', 50: '#eff6ff', 100: '#dbeafe' },
                        life: { 500: '#ec4899', 600: '#db2777', 50: '#fdf2f8', 100: '#fce7f3' }
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif; }
        .nav-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-btn:active { transform: scale(0.95); }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .flatpickr-calendar { border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; font-family: 'Poppins', sans-serif; z-index: 9999 !important; }
        .flatpickr-time input:hover, .flatpickr-time .flatpickr-am-pm:hover, .flatpickr-time input:focus, .flatpickr-time .flatpickr-am-pm:focus { background: #f3f4f6; }
        
        .timeline-line::before {
            content: ''; position: absolute; top: 2rem; bottom: -2rem; left: 1rem; width: 2px; background: #e5e7eb; z-index: 0;
        }
        .timeline-item:last-child .timeline-line::before { display: none; }

        .notebook-cover {
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .notebook-cover::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 12px;
            background: rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.05);
            z-index: 10;
        }
        .notebook-spine {
            position: absolute; left: 12px; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.05);
        }

        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes ring-swing {
            0% { transform: rotate(0deg); } 20% { transform: rotate(15deg); } 40% { transform: rotate(-10deg); }
            60% { transform: rotate(5deg); } 80% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); }
        }
        .bell-ringing { animation: ring-swing 1.5s infinite ease-in-out; transform-origin: top center; color: #dc2626 !important; }
        .slide-in-down { animation: slideInDown 0.5s ease-out forwards; }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .mobile-tab-btn.active-tab span:first-child { font-weight: 800; }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col bg-gray-50">

    <nav id="desktop-nav" class="bg-white/80 backdrop-blur-xl border-b border-gray-100 z-20 hidden md:flex items-center justify-between px-6 py-4 shrink-0 sticky top-0 relative">
        <button onclick="switchView('landing')" class="flex items-center gap-3 group focus:outline-none min-w-fit transition-transform active:scale-95 z-30">
            <div class="w-11 h-11 bg-gradient-to-br from-brand-900 to-gray-800 rounded-xl flex items-center justify-center text-white shadow-lg shadow-gray-200 group-hover:shadow-xl group-hover:scale-105 transition-all duration-300 relative overflow-hidden">
                <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i class="fa-solid fa-infinity text-xl group-hover:rotate-180 transition-transform duration-700 ease-in-out"></i>
            </div>
            <div class="text-left flex flex-col justify-center h-full">
                <h1 class="font-black text-xl tracking-tight leading-none text-gray-900 group-hover:text-work-600 transition-colors">
                    <span data-key="brand_name">Abdelrahman's</span>
                </h1>
                <span class="text-[10px] font-bold tracking-[0.2em] text-gray-400 uppercase" data-key="brand_sub">Life OS</span>
            </div>
        </button>

        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center gap-3 z-20">
            <button onclick="switchView('landing')" id="nav-landing" class="nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent">
                <i class="fa-solid fa-chart-pie text-sm"></i><span data-key="nav_dashboard">Dashboard</span>
            </button>
            <button onclick="switchView('work')" id="nav-work" class="nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent">
                <i class="fa-solid fa-briefcase text-sm"></i><span data-key="nav_work">Work</span>
            </button>
            <button onclick="switchView('home')" id="nav-home" class="nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent">
                <i class="fa-solid fa-house text-sm"></i><span data-key="nav_home">Home</span>
            </button>
            <button onclick="switchView('personal')" id="nav-personal" class="nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent">
                <i class="fa-solid fa-user text-sm"></i><span data-key="nav_personal">Personal</span>
            </button>
            <button onclick="switchView('history')" id="nav-history" class="nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent">
                <i class="fa-solid fa-clock-rotate-left text-sm"></i><span data-key="nav_history">History</span>
            </button>
        </div>

        <div class="flex items-center gap-3 min-w-fit justify-end z-30">
            <button onclick="checkOverduePopup()" class="bg-white text-gray-400 hover:text-gray-600 w-9 h-9 rounded-full text-sm font-bold border border-gray-200 shadow-sm transition flex items-center justify-center group relative overflow-visible">
                <i class="fa-solid fa-bell bell-icon"></i>
                <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden" id="notif-dot-desktop"></span>
            </button>
            <button onclick="switchView('settings')" id="nav-settings" class="w-9 h-9 rounded-full bg-gray-800 hover:bg-gray-700 text-white shadow-md shadow-gray-300 flex items-center justify-center transition hover:rotate-90">
                <i class="fa-solid fa-gear text-xs"></i>
            </button>
        </div>
    </nav>

    <main class="flex-1 h-full overflow-y-auto relative bg-gray-50/30 pb-20 md:pb-0 scroll-smooth">
        <header class="bg-white/80 p-4 md:hidden border-b sticky top-0 z-10 flex justify-between items-center shadow-sm backdrop-blur-md">
            <div>
                <h2 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h2>
                <p id="current-date" class="text-xs text-gray-500 font-medium mt-1"></p>
            </div>
            <div class="flex gap-2">
                 <button onclick="checkOverduePopup()" class="bg-white text-gray-400 hover:text-gray-600 px-3 py-1 rounded-full text-xs font-bold border border-gray-200 overflow-visible relative">
                    <i class="fa-solid fa-bell bell-icon"></i>
                    <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden" id="notif-dot-mobile"></span>
                 </button>
                 <button onclick="switchView('settings')" class="bg-white text-gray-400 hover:text-gray-600 px-3 py-1 rounded-full text-xs font-bold border border-gray-200 overflow-visible">
                    <i class="fa-solid fa-gear"></i>
                 </button>
            </div>
        </header>

        <div id="content-area" class="p-4 md:p-8 max-w-5xl mx-auto h-full"></div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-lg border-t border-gray-200 flex justify-around items-center p-2 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] safe-pb">
        <button onclick="switchView('work')" id="mob-work" class="flex flex-col items-center gap-1 p-2 text-gray-400"><i class="fa-solid fa-briefcase text-xl"></i><span class="text-[10px] font-bold" data-key="nav_work">Work</span></button>
        <button onclick="switchView('home')" id="mob-home" class="flex flex-col items-center gap-1 p-2 text-gray-400"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold" data-key="nav_home">Home</span></button>
        <div class="relative -top-5"><button onclick="switchView('landing')" class="w-14 h-14 bg-brand-900 rounded-full text-white shadow-lg flex items-center justify-center text-2xl border-4 border-gray-50"><i class="fa-solid fa-rocket"></i></button></div>
        <button onclick="switchView('personal')" id="mob-personal" class="flex flex-col items-center gap-1 p-2 text-gray-400"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold" data-key="nav_personal">Pers</span></button>
        <button onclick="switchView('history')" id="mob-history" class="flex flex-col items-center gap-1 p-2 text-gray-400"><i class="fa-solid fa-clock-rotate-left text-xl"></i><span class="text-[10px] font-bold" data-key="nav_history">Hist</span></button>
    </nav>

    <div id="noteEntryModal" class="fixed inset-0 bg-black/60 hidden z-[110] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-pop transform scale-100">
            <div class="p-4 bg-learning-600 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i> Add Note</h3>
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('noteEntryModal').classList.add('hidden'); openNotebook()" class="bg-white text-learning-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-gray-100 transition shadow-lg flex items-center gap-2 transform hover:scale-105 active:scale-95 border-2 border-white">
                        <i class="fa-solid fa-book-open"></i> <span>MY NOTEBOOK</span>
                    </button>
                    <button onclick="document.getElementById('noteEntryModal').classList.add('hidden')" class="text-white hover:text-blue-200 transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
                </div>
            </div>
            <form onsubmit="event.preventDefault(); saveNote();" class="p-6">
                <input type="hidden" id="targetCourseId">
                <div class="mb-4" id="courseTitleGroup">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Course / Topic Name</label>
                    <input type="text" id="noteCourse" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-learning-600 outline-none transition" placeholder="e.g. UX Design Masterclass">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Note Content</label>
                    <textarea id="noteContent" rows="4" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-learning-600 outline-none transition" placeholder="Write your key takeaways here..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Images (Optional - Select Multiple)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition cursor-pointer relative min-h-[100px] flex items-center justify-center">
                        <input type="file" id="noteImage" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImages(this)">
                        <div id="imagePreviewBox" class="text-gray-400">
                            <i class="fa-solid fa-images text-3xl mb-2"></i>
                            <p class="text-xs">Click to upload images</p>
                        </div>
                        <div id="imagePreviewGrid" class="hidden grid grid-cols-4 gap-2 w-full absolute inset-0 p-2 z-0 overflow-auto bg-white/80">
                            </div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-learning-600 text-white font-bold py-3 rounded-xl hover:bg-learning-500 transition shadow-lg shadow-learning-200">Save Note ðŸ’¾</button>
            </form>
        </div>
    </div>

    <div id="notebookModal" class="fixed inset-0 bg-gray-100 hidden z-[100] overflow-y-auto">
        <div class="min-h-screen p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-gray-100/90 backdrop-blur-sm z-10 py-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800">My Notebook ðŸ“’</h2>
                        <p class="text-gray-500 text-sm">Your learning repository.</p>
                    </div>
                    <button onclick="document.getElementById('notebookModal').classList.add('hidden')" class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="relative w-full mb-8 max-w-lg mx-auto">
                    <input type="text" oninput="filterNotebookLive(this.value)" placeholder="Search courses..." class="w-full pl-12 pr-4 py-4 rounded-2xl border-none bg-white shadow-sm focus:ring-2 focus:ring-learning-500 outline-none transition text-gray-600">
                    <i class="fa-solid fa-search absolute left-5 top-5 text-gray-300"></i>
                </div>

                <div id="notebookGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-24">
                    </div>
            </div>
        </div>
    </div>

    <div id="courseViewModal" class="fixed inset-0 bg-gray-50 hidden z-[105] overflow-y-auto">
        <div class="min-h-screen relative">
            <div id="courseHeaderBg" class="h-64 bg-gradient-to-r from-blue-600 to-purple-600 relative">
                <button onclick="document.getElementById('courseViewModal').classList.add('hidden')" class="absolute top-6 right-6 bg-black/20 hover:bg-black/40 text-white w-10 h-10 rounded-full flex items-center justify-center transition backdrop-blur-md z-20"><i class="fa-solid fa-xmark"></i></button>
                <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-gray-50 to-transparent"></div>
                <div class="absolute bottom-6 left-6 md:left-10 text-white z-10">
                    <span class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider mb-2 inline-block">Course</span>
                    <h1 id="courseTitleDisplay" class="text-3xl md:text-5xl font-black shadow-black drop-shadow-lg">UX Design</h1>
                </div>
            </div>

            <div class="max-w-3xl mx-auto px-6 -mt-10 relative z-10 pb-32">
                <div id="courseTimeline" class="space-y-8">
                    </div>
            </div>

            <button onclick="openAddEntryForCurrent()" class="fixed bottom-8 right-8 bg-learning-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition hover:bg-learning-500 z-30 border-4 border-white animate-pop">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </div>

    <div id="taskModal" class="fixed inset-0 bg-black/60 hidden z-[100] flex items-center justify-center backdrop-blur-sm transition-opacity p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-pop transform scale-100 relative">
            <div id="modalHeader" class="p-4 md:p-5 flex justify-between items-center text-white bg-gray-800">
                <h3 class="text-lg md:text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i> <span data-key="modal_add_title">New Task</span></h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-300"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form onsubmit="event.preventDefault(); saveTask();" class="p-4 md:p-6">
                <input type="hidden" id="taskCategory">
                <div id="subCategoryBadge" class="hidden mb-4 p-3 bg-gray-50 rounded-lg text-center border border-gray-200">
                    <span class="text-xs text-gray-500 font-bold block mb-1">Adding to:</span>
                    <span id="badgeText" class="font-bold text-lg"></span>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700" data-key="modal_task_label">Title</label>
                    <input type="text" id="taskTitle" class="w-full p-3 md:p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-base md:text-lg transition" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700" data-key="modal_date_label">Date</label>
                    <input type="text" id="taskDate" class="w-full p-3 border-2 border-gray-200 rounded-xl bg-gray-50 outline-none" placeholder="Select Date" required>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                <i class="fa-regular fa-clock"></i>
                            </div>
                            Set Time?
                        </label>
                        <button type="button" id="timeToggleBtn" onclick="toggleTimeInput()" class="w-12 h-7 bg-gray-200 rounded-full relative transition-colors duration-300 focus:outline-none">
                            <div id="timeToggleCircle" class="w-5 h-5 bg-white rounded-full shadow-md absolute top-1 left-1 transition-transform duration-300 transform translate-x-0"></div>
                        </button>
                    </div>

                    <div id="timeInputContainer" class="hidden transition-all duration-300 ease-in-out origin-top transform scale-y-95 opacity-0">
                        <div class="grid grid-cols-2 gap-4">
                            
                            <div class="relative group">
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1 text-center">Start</p>
                                <input type="text" id="taskTimeFrom" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                                
                                <div class="bg-gray-100 rounded-2xl p-2 flex items-center justify-center gap-1 border-2 border-transparent group-hover:border-blue-200 transition-colors">
                                    <div id="visual-from-hour" class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-lg font-black text-lg shadow-sm shadow-blue-300">
                                        09
                                    </div>
                                    <span class="font-bold text-gray-400 text-lg">:</span>
                                    <div id="visual-from-min" class="bg-white text-gray-800 w-10 h-10 flex items-center justify-center rounded-lg font-bold text-lg shadow-sm">
                                        00
                                    </div>
                                    <div id="visual-from-ampm" class="bg-white text-gray-500 w-10 h-10 flex items-center justify-center rounded-lg font-bold text-xs shadow-sm ml-1 uppercase">
                                        AM
                                    </div>
                                </div>
                            </div>

                            <div class="relative group">
                                <div class="flex justify-between items-center mb-1">
                                     <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest text-center w-full">End</p>
                                     <button type="button" id="clearEndTimeBtn" onclick="clearTime('taskTimeTo', event)" class="hidden text-gray-400 hover:text-red-500 absolute right-0 -top-1 z-30"><i class="fa-solid fa-xmark"></i></button>
                                </div>

                                <input type="text" id="taskTimeTo" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                                
                                <div class="bg-gray-100 rounded-2xl p-2 flex items-center justify-center gap-1 border-2 border-transparent group-hover:border-blue-200 transition-colors">
                                    <div id="visual-to-hour" class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-lg font-black text-lg shadow-sm shadow-blue-300">
                                        10
                                    </div>
                                    <span class="font-bold text-gray-400 text-lg">:</span>
                                    <div id="visual-to-min" class="bg-white text-gray-800 w-10 h-10 flex items-center justify-center rounded-lg font-bold text-lg shadow-sm">
                                        00
                                    </div>
                                    <div id="visual-to-ampm" class="bg-white text-gray-500 w-10 h-10 flex items-center justify-center rounded-lg font-bold text-xs shadow-sm ml-1 uppercase">
                                        AM
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t mt-4">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold text-sm" data-key="btn_cancel">Cancel</button>
                    <button type="submit" id="saveBtn" class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:opacity-90 shadow-lg font-bold transition transform active:scale-95 text-sm md:text-base" data-key="btn_save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="rescheduleModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center backdrop-blur-sm transition-opacity p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-pop transform scale-100">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-calendar-days"></i> <span data-key="modal_reschedule_title">Reschedule</span></h3>
                <button onclick="closeRescheduleModal()" class="text-white hover:text-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <label class="block text-sm font-bold mb-2 text-gray-700" data-key="modal_new_date">New Date & Time</label>
                <input type="text" id="newRescheduleDate" class="w-full p-3 border-2 border-blue-100 focus:border-blue-500 rounded-xl bg-blue-50 outline-none transition mb-4" placeholder="Select New Date">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1 relative">
                        <input type="text" id="rescheduleTimeFrom" class="w-full p-3 pl-8 border-2 border-blue-100 rounded-xl bg-blue-50 outline-none focus:border-blue-500 transition cursor-pointer text-sm" placeholder="From" readonly>
                        <i class="fa-regular fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-blue-300"></i>
                    </div>
                    <div class="flex-1 relative">
                        <input type="text" id="rescheduleTimeTo" class="w-full p-3 pl-8 border-2 border-blue-100 rounded-xl bg-blue-50 outline-none focus:border-blue-500 transition cursor-pointer text-sm" placeholder="To" readonly>
                        <i class="fa-regular fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-blue-300"></i>
                         <div class="absolute right-2 top-3 cursor-pointer text-blue-300 hover:text-red-400" onclick="clearTime('rescheduleTimeTo', event)">
                            <i class="fa-solid fa-xmark text-[10px]"></i>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeRescheduleModal()" class="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-bold text-sm" data-key="btn_cancel">Cancel</button>
                    <button onclick="confirmReschedule()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition" data-key="btn_confirm">Update</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="warningModal" class="fixed inset-0 bg-red-900/80 hidden z-[60] flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden animate-shake transform scale-100 border-4 border-red-500">
            <div class="p-4 bg-red-500 text-white flex justify-between items-center">
                <h3 class="text-lg font-black flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> <span data-key="alert_title">Alert!</span></h3>
                <button onclick="document.getElementById('warningModal').classList.add('hidden')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-gray-700 font-bold mb-4" data-key="alert_msg">You have overdue tasks!</p>
                <div id="overdueList" class="space-y-2 max-h-64 overflow-y-auto pr-2 mb-6"></div>
                <button onclick="openBatchRescheduleModal()" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl transition text-sm">
                    <i class="fa-solid fa-layer-group"></i> <span data-key="btn_reschedule">Reschedule All</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const txt = {
            brand_name: "Abdelrahman's", brand_sub: "Life OS",
            nav_dashboard: 'Dashboard', nav_work: 'Work', nav_home: 'Home', nav_personal: 'Personal', nav_history: 'Timeline', nav_settings: 'Settings',
            page_dashboard: 'Performance Overview', page_work: 'ðŸ’¼ Work Mode', page_home: 'ðŸ  Home Mode', page_personal: 'ðŸ‘¤ Personal Mode', page_history: 'ðŸ“‚ Time Travel', page_settings: 'âš™ï¸ Settings',
            card_work_desc: 'Manage tasks & projects', card_home_desc: 'House & family needs', card_personal_desc: 'Self improvement & hobbies',
            perf_rate: 'Overall Completion Rate', perf_week: 'Tasks Completed (Last 7 Days)',
            empty_perf: 'Add tasks to start tracking', perf_high: 'ðŸ”¥ðŸ”¥ World Class Performance!', perf_mid: 'ðŸ‘ Good... Keep going', perf_low: 'âš ï¸ Needs Focus',
            total: 'Total', done: 'Done', overdue: 'Overdue', btn_new: 'New Task',
            col_today: 'Focus (Today & Overdue) ðŸš¨', col_week: 'This Week ðŸ“…', col_later: 'Later ðŸš€', empty_col: 'Empty!',
            modal_add_title: 'Add New Task', modal_task_label: 'Task Title', modal_date_label: 'Due Date', btn_save: 'Save Task', btn_cancel: 'Cancel', task_placeholder: 'What needs to be done?',
            alert_title: 'Important Alert!', alert_msg: 'You have overdue tasks pending action!', btn_reschedule: 'Reschedule All Batch',
            hist_title: 'Your Timeline', hist_empty: 'No records for this month. A fresh start!', hist_search: 'Search history...', hist_total: 'Completed in',
            hist_select_month: 'Select Month', hist_all_months: 'All Time',
            set_title: 'General Settings', set_danger: 'Danger Zone', btn_reset: 'ðŸ—‘ï¸ Reset All Data', confirm_reset: 'Are you sure?', confirm_del: 'Delete Task?',
            reschedule_done: 'Rescheduled successfully! ðŸ’ª', level_up: 'Level Up! ðŸŽ‰',
            loc_egypt: 'Egypt ðŸ‡ªðŸ‡¬', loc_ksa: 'KSA ðŸ‡¸ðŸ‡¦',
            type_learning: 'Learning ðŸ“š', type_life: 'Life ðŸŒ±',
            modal_reschedule_title: 'Reschedule', modal_new_date: 'Select New Date', btn_confirm: 'Update',
            brief_morning: 'Good Morning, Abdelrahman! â˜€ï¸', brief_evening: 'Good Evening, Abdelrahman! ðŸŒ™', brief_msg: 'You have {n} tasks for today.', brief_btn: "Let's Go ðŸš€",
            hist_back: 'Back', hist_work_btn: 'Work ðŸ’¼', hist_home_btn: 'Home ðŸ ', hist_personal_btn: 'Personal ðŸ‘¤',
            month_completed: 'Tasks Completed'
        };

        let tasks = JSON.parse(localStorage.getItem('lifeOS_tasks_v7')) || [];
        let learningNotebooks = JSON.parse(localStorage.getItem('lifeOS_learning_notebooks_v2')) || [];
        if(!Array.isArray(learningNotebooks)) learningNotebooks = [];

        let userStats = JSON.parse(localStorage.getItem('lifeOS_stats_v7')) || { level: 1, xp: 0, nextLevelXp: 100, name: 'Abdelrahman' };
        let currentView = 'landing';
        let workLocation = 'egypt'; 
        let personalSub = 'learning'; 
        let completionChart = null;
        let weeklyChart = null;
        let taskToRescheduleId = null; 
        let rescheduleMode = 'single';
        
        let historySubView = 'main'; 
        const today = new Date();
        let historyMonthFilter = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        let historyYearFilter = new Date().getFullYear(); 
        
        let currentMobileTab = 'today';
        let currentOpenedCourseId = null;

        let datePicker, rescheduleDatePicker, timePickerFrom, timePickerTo, rescheduleTimePickerFrom, rescheduleTimePickerTo;
        let isTimeEnabled = false;

        document.addEventListener('DOMContentLoaded', () => {
             datePicker = flatpickr("#taskDate", { dateFormat: "Y-m-d", disableMobile: "true" });
             rescheduleDatePicker = flatpickr("#newRescheduleDate", { dateFormat: "Y-m-d", disableMobile: "true" });
             
             // --- VISUAL TIME PICKER LOGIC ---
             
             // Update visual blocks
             const updateVisualWheel = (dateObj, prefix) => {
                if (!dateObj) {
                    document.getElementById(`visual-${prefix}-hour`).innerText = '--';
                    document.getElementById(`visual-${prefix}-min`).innerText = '--';
                    document.getElementById(`visual-${prefix}-ampm`).innerText = '--';
                    return;
                }
                
                let hours = dateObj.getHours();
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12; 
                const strHours = String(hours).padStart(2, '0');

                document.getElementById(`visual-${prefix}-hour`).innerText = strHours;
                document.getElementById(`visual-${prefix}-min`).innerText = minutes;
                document.getElementById(`visual-${prefix}-ampm`).innerText = ampm;
            };

             timePickerFrom = flatpickr("#taskTimeFrom", { 
                 enableTime: true, 
                 noCalendar: true, 
                 dateFormat: "h:i K", 
                 time_24hr: false, 
                 disableMobile: "true",
                 onChange: (selectedDates) => {
                    if(selectedDates[0]) updateVisualWheel(selectedDates[0], 'from');
                 }
             });
             
             timePickerTo = flatpickr("#taskTimeTo", { 
                 enableTime: true, 
                 noCalendar: true, 
                 dateFormat: "h:i K", 
                 time_24hr: false, 
                 disableMobile: "true",
                 onChange: (selectedDates) => {
                    if(selectedDates[0]) {
                        updateVisualWheel(selectedDates[0], 'to');
                        document.getElementById('clearEndTimeBtn').classList.remove('hidden');
                    } else {
                        updateVisualWheel(null, 'to');
                        document.getElementById('clearEndTimeBtn').classList.add('hidden');
                    }
                 }
             });

             rescheduleTimePickerFrom = flatpickr("#rescheduleTimeFrom", { enableTime: true, noCalendar: true, dateFormat: "h:i K", time_24hr: false, disableMobile: "true" });
             rescheduleTimePickerTo = flatpickr("#rescheduleTimeTo", { enableTime: true, noCalendar: true, dateFormat: "h:i K", time_24hr: false, disableMobile: "true" });

             updateDate();
             renderContent();
             
             // Defaults for visual
             updateVisualWheel(null, 'from');
             updateVisualWheel(null, 'to');
        });
        
        function toggleTimeInput() {
            isTimeEnabled = !isTimeEnabled;
            const btn = document.getElementById('timeToggleBtn');
            const circle = document.getElementById('timeToggleCircle');
            const container = document.getElementById('timeInputContainer');
            const inputFrom = document.getElementById('taskTimeFrom');

            if (isTimeEnabled) {
                // Active state
                btn.classList.remove('bg-gray-200');
                btn.classList.add('bg-blue-600');
                circle.style.transform = 'translateX(20px)';
                
                container.classList.remove('hidden');
                setTimeout(() => {
                    container.classList.remove('scale-y-95', 'opacity-0');
                    container.classList.add('scale-y-100', 'opacity-100');
                }, 10);

                // Auto open picker if empty
                if(!inputFrom.value) {
                    timePickerFrom.open();
                }

            } else {
                // Inactive state
                btn.classList.add('bg-gray-200');
                btn.classList.remove('bg-blue-600');
                circle.style.transform = 'translateX(0)';

                container.classList.remove('scale-y-100', 'opacity-100');
                container.classList.add('scale-y-95', 'opacity-0');
                
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 300);

                timePickerFrom.clear();
                timePickerTo.clear();
                
                // Reset Visuals
                document.getElementById(`visual-from-hour`).innerText = '09';
                document.getElementById(`visual-from-min`).innerText = '00';
                document.getElementById(`visual-from-ampm`).innerText = 'AM';
                document.getElementById(`visual-to-hour`).innerText = '10';
                document.getElementById(`visual-to-min`).innerText = '00';
                document.getElementById(`visual-to-ampm`).innerText = 'AM';
            }
        }

        function updateDate() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        setTimeout(() => {
            checkOverduePopup();
            checkDailyBriefing(); 
        }, 1000);

        function switchView(view) {
            currentView = view;
            if (view !== 'history') historySubView = 'main';
            else if (view === 'history' && historySubView !== 'main') historySubView = 'main';

            const themes = {
                landing: { active: 'bg-gray-100 text-gray-800 ring-2 ring-gray-200 shadow-sm', inactive: 'bg-white text-gray-500 hover:bg-gray-50' },
                work: { active: 'bg-work-50 text-work-600 ring-2 ring-work-200 shadow-sm', inactive: 'bg-white text-work-600/70 hover:bg-work-50 hover:text-work-600' },
                home: { active: 'bg-home-50 text-home-600 ring-2 ring-home-200 shadow-sm', inactive: 'bg-white text-home-600/70 hover:bg-home-50 hover:text-home-600' },
                personal: { active: 'bg-personal-50 text-personal-600 ring-2 ring-personal-200 shadow-sm', inactive: 'bg-white text-personal-600/70 hover:bg-personal-50 hover:text-personal-600' },
                history: { active: 'bg-blue-50 text-blue-600 ring-2 ring-blue-200 shadow-sm', inactive: 'bg-white text-blue-600/70 hover:bg-blue-50 hover:text-blue-600' }
            };

            Object.keys(themes).forEach(v => { const btn = document.getElementById(`nav-${v}`); if(btn) btn.className = `nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent ${themes[v].inactive}`; });
            const activeBtn = document.getElementById(`nav-${view}`); if(activeBtn && themes[view]) activeBtn.className = `nav-btn px-5 py-2.5 rounded-2xl text-xs font-bold flex items-center gap-2 transition-all border border-transparent ${themes[view].active}`;
            document.querySelectorAll('nav:not(#desktop-nav) button').forEach(btn => btn.classList.remove('mobile-nav-active', 'text-brand-900'));
            if(document.getElementById(`mob-${view}`)) { document.getElementById(`mob-${view}`).classList.add('mobile-nav-active', 'text-brand-900'); document.getElementById(`mob-${view}`).classList.remove('text-gray-400'); }
            
            const titleEl = document.getElementById('page-title');
            const viewKey = `page_${view === 'landing' ? 'dashboard' : view}`;
            if(titleEl && txt[viewKey]) titleEl.innerText = txt[viewKey];
            
            currentMobileTab = 'today';
            renderContent();
        }

        function switchMobileTab(tab) {
            currentMobileTab = tab;
            renderContent(); 
        }

        function setHistoryView(subView) { historySubView = subView; renderContent(); }
        function setHistoryMonth(month) { historyMonthFilter = month; const searchInput = document.querySelector('#historySearchInput'); const searchValue = searchInput ? searchInput.value : ''; renderContent(searchValue); }
        
        function changeHistoryYear(delta) {
            historyYearFilter += delta;
            renderContent();
        }

        function scrollMonths(direction) { const container = document.getElementById('monthScroller'); if(container) { const scrollAmount = 300; if(direction === 'left') container.scrollBy({ left: -scrollAmount, behavior: 'smooth' }); else container.scrollBy({ left: scrollAmount, behavior: 'smooth' }); } }
        function switchWorkLoc(loc) { workLocation = loc; renderContent(); }
        function switchPersonalSub(sub) { personalSub = sub; renderContent(); }

        // --- NOTEBOOK FUNCTIONS ---
        function openNoteEntry() {
            document.getElementById('noteEntryModal').classList.remove('hidden');
            document.getElementById('targetCourseId').value = ''; 
            document.getElementById('courseTitleGroup').classList.remove('hidden');
            document.getElementById('noteCourse').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteImage').value = '';
            document.getElementById('imagePreviewGrid').innerHTML = '';
            document.getElementById('imagePreviewGrid').classList.add('hidden');
            document.getElementById('imagePreviewBox').classList.remove('hidden');
        }

        function openAddEntryForCurrent() {
            if(!currentOpenedCourseId) return;
            const course = learningNotebooks.find(c => c.id === currentOpenedCourseId);
            if(!course) return;

            document.getElementById('noteEntryModal').classList.remove('hidden');
            document.getElementById('targetCourseId').value = course.id; 
            document.getElementById('courseTitleGroup').classList.add('hidden');
            document.getElementById('noteContent').value = '';
            document.getElementById('noteImage').value = '';
            document.getElementById('imagePreviewGrid').innerHTML = '';
            document.getElementById('imagePreviewGrid').classList.add('hidden');
            document.getElementById('imagePreviewBox').classList.remove('hidden');
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        function previewImages(input) {
            const grid = document.getElementById('imagePreviewGrid');
            const box = document.getElementById('imagePreviewBox');
            grid.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                box.classList.add('hidden');
                grid.classList.remove('hidden');
                
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-20 object-cover rounded-md shadow-sm border border-gray-100';
                        grid.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            } else {
                box.classList.remove('hidden');
                grid.classList.add('hidden');
            }
        }

        function saveNote() {
            const targetId = document.getElementById('targetCourseId').value;
            const courseNameInput = document.getElementById('noteCourse').value;
            const content = document.getElementById('noteContent').value;
            const imageInput = document.getElementById('noteImage');
            
            if (!targetId && !courseNameInput) return;

            const processImages = (files) => {
                return Promise.all(Array.from(files).map(file => compressImage(file)));
            };

            const processSave = (imagesArray) => {
                const newEntry = {
                    id: Date.now(),
                    content: content,
                    images: imagesArray, 
                    date: new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' })
                };

                if(!Array.isArray(learningNotebooks)) learningNotebooks = [];

                if (targetId) {
                    const courseIndex = learningNotebooks.findIndex(c => c.id == targetId);
                    if (courseIndex > -1) {
                        if(!learningNotebooks[courseIndex].entries) learningNotebooks[courseIndex].entries = [];
                        learningNotebooks[courseIndex].entries.unshift(newEntry);
                        learningNotebooks[courseIndex].updatedAt = Date.now();
                        
                        if(imagesArray.length > 0 && !learningNotebooks[courseIndex].coverImage) {
                             learningNotebooks[courseIndex].coverImage = imagesArray[0];
                        }
                    }
                } else {
                    learningNotebooks.unshift({
                        id: Date.now(),
                        title: courseNameInput,
                        coverImage: imagesArray.length > 0 ? imagesArray[0] : null, 
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        entries: [newEntry]
                    });
                }

                try {
                    localStorage.setItem('lifeOS_learning_notebooks_v2', JSON.stringify(learningNotebooks));
                    document.getElementById('noteEntryModal').classList.add('hidden');
                    confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 } });
                    
                    if (currentOpenedCourseId && (targetId == currentOpenedCourseId)) {
                        viewCourseTimeline(parseInt(targetId));
                    } else {
                        renderNotebook(); 
                    }
                } catch (e) {
                    alert("Storage is full even after compression! Try deleting old notes or using fewer images.");
                }
            };

            if (imageInput.files && imageInput.files.length > 0) {
                const submitBtn = document.querySelector('#noteEntryModal button[type="submit"]');
                const oldText = submitBtn.innerText;
                submitBtn.innerText = 'Compressing & Saving... â³';
                submitBtn.disabled = true;

                processImages(imageInput.files).then(images => {
                    processSave(images);
                    submitBtn.innerText = oldText;
                    submitBtn.disabled = false;
                });
            } else {
                processSave([]);
            }
        }

        function openNotebook() {
            document.getElementById('notebookModal').classList.remove('hidden');
            renderNotebook();
        }

        function filterNotebookLive(query) {
            const grid = document.getElementById('notebookGrid');
            const cards = grid.children;
            for (let card of cards) {
                const title = card.getAttribute('data-title').toLowerCase();
                if (title.includes(query.toLowerCase())) card.classList.remove('hidden');
                else card.classList.add('hidden');
            }
        }

        function getRandomGradient(id) {
            const grads = [
                'from-pink-500 to-rose-500', 'from-blue-400 to-indigo-500', 'from-emerald-400 to-cyan-500',
                'from-orange-400 to-pink-500', 'from-violet-500 to-purple-500', 'from-amber-400 to-orange-500'
            ];
            return grads[id % grads.length];
        }

        function deleteCourse(id, e) {
            e.stopPropagation();
            if(confirm('Are you sure you want to delete this entire notebook and all its notes? ðŸ—‘ï¸')) {
                learningNotebooks = learningNotebooks.filter(b => b.id !== id);
                localStorage.setItem('lifeOS_learning_notebooks_v2', JSON.stringify(learningNotebooks));
                renderNotebook();
            }
        }

        function renderNotebook() {
            const grid = document.getElementById('notebookGrid');
            if (!Array.isArray(learningNotebooks) || learningNotebooks.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400 flex flex-col items-center"><i class="fa-solid fa-book-open text-6xl mb-4 opacity-30"></i><p>Your notebook is empty.</p></div>`;
                return;
            }
            grid.innerHTML = learningNotebooks.map(book => {
                const count = book.entries ? book.entries.length : 0;
                const grad = getRandomGradient(book.id);
                return `
                <div onclick="viewCourseTimeline(${book.id})" data-title="${book.title}" class="notebook-cover bg-white rounded-r-2xl rounded-l-md shadow-md hover:shadow-xl cursor-pointer overflow-hidden group h-64 flex flex-col relative animate-fade transform hover:-translate-y-1 transition-all duration-300 border border-gray-100">
                    <div class="notebook-spine"></div>
                    <button onclick="deleteCourse(${book.id}, event)" class="absolute top-2 right-2 z-30 bg-white/90 hover:bg-red-500 hover:text-white text-gray-400 w-7 h-7 rounded-full flex items-center justify-center shadow-sm transition-all" title="Delete Course">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    <div class="h-32 w-full ${book.coverImage ? '' : `bg-gradient-to-br ${grad}`} relative">
                        ${book.coverImage ? `<img src="${book.coverImage}" class="w-full h-full object-cover">` : ''}
                        <div class="absolute top-3 right-3 bg-black/50 backdrop-blur-md text-white text-xs font-bold px-2 py-1 rounded-lg shadow-sm">
                            ${count} Notes
                        </div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col justify-between bg-white relative z-20">
                        <div>
                            <h3 class="font-black text-xl text-gray-800 leading-tight mb-2 line-clamp-2 group-hover:text-learning-600 transition-colors">${book.title}</h3>
                            <p class="text-xs text-gray-400">Last updated: ${new Date(book.updatedAt).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-bold text-gray-400 group-hover:text-learning-500 transition-colors mt-4">
                            <span>Open Notebook</span> <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function viewCourseTimeline(id) {
            const course = learningNotebooks.find(c => c.id === id);
            if (!course) return;
            currentOpenedCourseId = id;

            document.getElementById('courseTitleDisplay').innerText = course.title;
            const headerBg = document.getElementById('courseHeaderBg');
            if (course.coverImage) {
                headerBg.style.backgroundImage = `url('${course.coverImage}')`;
                headerBg.style.backgroundSize = 'cover';
                headerBg.style.backgroundPosition = 'center';
                headerBg.className = 'h-64 relative';
            } else {
                headerBg.style.backgroundImage = 'none';
                headerBg.className = `h-64 bg-gradient-to-r ${getRandomGradient(course.id)} relative`;
            }

            const timeline = document.getElementById('courseTimeline');
            if (!course.entries || course.entries.length === 0) {
                timeline.innerHTML = `<div class="text-center text-gray-400 py-10">No notes yet. Add one!</div>`;
            } else {
                timeline.innerHTML = course.entries.map((entry, idx) => {
                    let imagesHTML = '';
                    if (entry.images && entry.images.length > 0) {
                        const gridClass = entry.images.length === 1 ? 'grid-cols-1' : (entry.images.length === 2 ? 'grid-cols-2' : 'grid-cols-3');
                        imagesHTML = `
                            <div class="grid ${gridClass} gap-2 mt-3">
                                ${entry.images.map(img => `<img src="${img}" class="rounded-xl w-full h-32 object-cover border border-gray-100 shadow-sm cursor-pointer hover:scale-[1.02] transition" onclick="window.open(this.src)">`).join('')}
                            </div>
                        `;
                    } else if (entry.image) { 
                         imagesHTML = `<img src="${entry.image}" class="rounded-xl max-h-60 object-cover border border-gray-100 shadow-sm cursor-pointer hover:scale-[1.01] transition mt-3" onclick="window.open(this.src)">`;
                    }

                    return `
                    <div class="relative pl-8 animate-slide-up" style="animation-delay: ${idx * 0.05}s">
                        ${idx !== course.entries.length - 1 ? '<div class="absolute left-[11px] top-8 bottom-[-32px] w-0.5 bg-gray-200"></div>' : ''}
                        <div class="absolute left-0 top-1.5 w-6 h-6 bg-learning-100 rounded-full flex items-center justify-center border-2 border-white shadow-sm z-10">
                            <div class="w-2 h-2 bg-learning-600 rounded-full"></div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start mb-3">
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${entry.date}</p>
                                <button onclick="deleteNoteEntry(${course.id}, ${entry.id})" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                            ${entry.content ? `<div class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">${entry.content}</div>` : ''}
                            ${imagesHTML}
                        </div>
                    </div>
                `}).join('');
            }

            document.getElementById('courseViewModal').classList.remove('hidden');
        }

        function deleteNoteEntry(courseId, entryId) {
            if(confirm('Delete this entry?')) {
                const courseIndex = learningNotebooks.findIndex(c => c.id === courseId);
                if(courseIndex > -1) {
                    learningNotebooks[courseIndex].entries = learningNotebooks[courseIndex].entries.filter(e => e.id !== entryId);
                    localStorage.setItem('lifeOS_learning_notebooks_v2', JSON.stringify(learningNotebooks));
                    viewCourseTimeline(courseId); 
                }
            }
        }

        function filterHistoryLive(query) {
            const items = document.querySelectorAll('.timeline-item');
            const noResultsMsg = document.getElementById('historyNoResults');
            let hasVisible = false;

            items.forEach(item => {
                const title = item.querySelector('h4').innerText.toLowerCase();
                if (title.includes(query.toLowerCase())) {
                    item.classList.remove('hidden');
                    hasVisible = true;
                } else {
                    item.classList.add('hidden');
                }
            });

            if (noResultsMsg) {
                if (!hasVisible && items.length > 0) noResultsMsg.classList.remove('hidden');
                else noResultsMsg.classList.add('hidden');
            }
        }

        function renderContent(searchQuery = '') {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            
            if(completionChart) { completionChart.destroy(); completionChart = null; }
            if(weeklyChart) { weeklyChart.destroy(); weeklyChart = null; }
            if (currentView === 'landing') renderLanding(container, txt);
            else if (currentView === 'work') renderCategoryDashboard(container, 'work', txt);
            else if (currentView === 'home') renderCategoryDashboard(container, 'home', txt);
            else if (currentView === 'personal') renderCategoryDashboard(container, 'personal', txt);
            else if (currentView === 'history') renderHistoryCreative(container, txt, searchQuery);
            else if (currentView === 'settings') renderSettings(container, txt);
        }

        function countWeekly(cat) {
            const now = new Date(); now.setHours(0,0,0,0);
            const nextWeek = new Date(now); nextWeek.setDate(now.getDate() + 7);
            return tasks.filter(t => {
                if (t.category !== cat || t.status === 'done') return false;
                const d = new Date(t.date); d.setHours(0,0,0,0);
                return d > now && d <= nextWeek;
            }).length;
        }

        function renderLanding(container, txt) {
            const workOverdue = countOverdue('work');
            const homeOverdue = countOverdue('home');
            const personalOverdue = countOverdue('personal');
            const workWeek = countWeekly('work');
            const homeWeek = countWeekly('home');
            const personalWeek = countWeekly('personal');
            
            container.innerHTML = `
            <div class="animate-fade pb-10">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 w-full mb-8">
                    <button onclick="switchView('work')" class="glass hover:bg-white border-none rounded-3xl p-6 md:p-8 transition-all shadow-sm hover:shadow-xl text-center active:scale-95 duration-300 group relative">
                        ${workOverdue > 0 ? `<div class="absolute top-4 left-4 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold animate-bounce shadow-md ring-2 ring-white">${workOverdue}</div>` : ''}
                        ${workWeek > 0 ? `<div class="absolute top-4 right-4 bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md ring-2 ring-white animate-pulse">${workWeek}</div>` : ''}
                        
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-work-50 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-briefcase text-3xl md:text-4xl text-work-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${txt.nav_work}</h3>
                        <p class="text-xs text-gray-400">${txt.card_work_desc}</p>
                    </button>
                    
                    <button onclick="switchView('home')" class="glass hover:bg-white border-none rounded-3xl p-6 md:p-8 transition-all shadow-sm hover:shadow-xl text-center active:scale-95 duration-300 group relative">
                        ${homeOverdue > 0 ? `<div class="absolute top-4 left-4 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold animate-bounce shadow-md ring-2 ring-white">${homeOverdue}</div>` : ''}
                        ${homeWeek > 0 ? `<div class="absolute top-4 right-4 bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md ring-2 ring-white animate-pulse">${homeWeek}</div>` : ''}

                        <div class="w-16 h-16 md:w-20 md:h-20 bg-home-50 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-house text-3xl md:text-4xl text-home-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${txt.nav_home}</h3>
                        <p class="text-xs text-gray-400">${txt.card_home_desc}</p>
                    </button>
                    
                    <button onclick="switchView('personal')" class="glass hover:bg-white border-none rounded-3xl p-6 md:p-8 transition-all shadow-sm hover:shadow-xl text-center active:scale-95 duration-300 group relative">
                        ${personalOverdue > 0 ? `<div class="absolute top-4 left-4 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold animate-bounce shadow-md ring-2 ring-white">${personalOverdue}</div>` : ''}
                        ${personalWeek > 0 ? `<div class="absolute top-4 right-4 bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md ring-2 ring-white animate-pulse">${personalWeek}</div>` : ''}

                        <div class="w-16 h-16 md:w-20 md:h-20 bg-personal-50 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-user text-3xl md:text-4xl text-personal-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${txt.nav_personal}</h3>
                        <p class="text-xs text-gray-400">${txt.card_personal_desc}</p>
                    </button>
                </div>
                <h3 class="font-bold text-lg md:text-2xl text-gray-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-chart-line text-brand-900"></i> ${txt.nav_dashboard}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-500 mb-6 text-sm">${txt.perf_rate}</h4>
                        <div class="relative h-48 md:h-64 w-full flex items-center justify-center"><canvas id="chartCompletion"></canvas></div>
                        <div id="performance-text" class="text-center mt-6 font-bold text-lg"></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-500 mb-6 text-sm">${txt.perf_week}</h4>
                        <div class="relative h-48 md:h-64 w-full"><canvas id="chartWeekly"></canvas></div>
                    </div>
                </div>
            </div>`;
            setTimeout(() => initCharts(txt), 100);
        }

        function renderCategoryDashboard(container, category, txt) {
            let filteredTasks = tasks.filter(t => t.category === category);
            let subNav = '';
            let extraButtons = ''; 

            const isWk = (t) => {
                if(t.status === 'done') return false;
                const now = new Date(); now.setHours(0,0,0,0);
                const next = new Date(now); next.setDate(now.getDate() + 7);
                const d = new Date(t.date); d.setHours(0,0,0,0);
                return d > now && d <= next;
            };

            const isLate = (t) => {
                 if(t.status === 'done') return false;
                 const now = new Date(); now.setHours(0,0,0,0);
                 const d = new Date(t.date); d.setHours(0,0,0,0);
                 return d < now;
            };

            if (category === 'work') {
                const egLate = tasks.filter(t => t.category === 'work' && t.workLocation === 'egypt' && isLate(t)).length;
                const egWeek = tasks.filter(t => t.category === 'work' && t.workLocation === 'egypt' && isWk(t)).length;
                const ksaLate = tasks.filter(t => t.category === 'work' && t.workLocation === 'ksa' && isLate(t)).length;
                const ksaWeek = tasks.filter(t => t.category === 'work' && t.workLocation === 'ksa' && isWk(t)).length;

                filteredTasks = filteredTasks.filter(t => t.workLocation === workLocation || (!t.workLocation && workLocation === 'egypt'));
                
                const styleEg = workLocation === 'egypt' ? 'bg-eg-500 text-white shadow-lg scale-105 border-eg-500 ring-2 ring-red-200' : 'bg-white text-gray-500 hover:bg-gray-50 border-gray-200';
                const styleKsa = workLocation === 'ksa' ? 'bg-ksa-500 text-white shadow-lg scale-105 border-ksa-500 ring-2 ring-green-200' : 'bg-white text-gray-500 hover:bg-gray-50 border-gray-200';
                
                subNav = `
                <div class="flex justify-center gap-4 mb-8">
                    <button onclick="switchWorkLoc('egypt')" class="relative px-6 py-2.5 rounded-full font-bold text-sm transition-all border flex items-center gap-2 ${styleEg}">
                        <span>${txt.loc_egypt}</span>
                        ${egLate > 0 ? `<div class="absolute -top-2 -right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white animate-pulse">${egLate}</div>` : ''}
                        ${egWeek > 0 ? `<div class="absolute -top-2 -left-1 bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white">${egWeek}</div>` : ''}
                    </button>
                    <button onclick="switchWorkLoc('ksa')" class="relative px-6 py-2.5 rounded-full font-bold text-sm transition-all border flex items-center gap-2 ${styleKsa}">
                        <span>${txt.loc_ksa}</span>
                        ${ksaLate > 0 ? `<div class="absolute -top-2 -right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white animate-pulse">${ksaLate}</div>` : ''}
                        ${ksaWeek > 0 ? `<div class="absolute -top-2 -left-1 bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white">${ksaWeek}</div>` : ''}
                    </button>
                </div>`;
            } else if (category === 'personal') {
                const learnLate = tasks.filter(t => t.category === 'personal' && t.personalType === 'learning' && isLate(t)).length;
                const learnWeek = tasks.filter(t => t.category === 'personal' && t.personalType === 'learning' && isWk(t)).length;
                const lifeLate = tasks.filter(t => t.category === 'personal' && (t.personalType === 'life' || !t.personalType) && isLate(t)).length;
                const lifeWeek = tasks.filter(t => t.category === 'personal' && (t.personalType === 'life' || !t.personalType) && isWk(t)).length;

                filteredTasks = filteredTasks.filter(t => t.personalType === personalSub || (!t.personalType && personalSub === 'life'));

                const styleLearn = personalSub === 'learning' ? 'bg-learning-500 text-white shadow-lg scale-105 border-learning-500 ring-2 ring-blue-200' : 'bg-white text-gray-500 hover:bg-gray-50 border-gray-200';
                const styleLife = personalSub === 'life' ? 'bg-life-500 text-white shadow-lg scale-105 border-life-500 ring-2 ring-pink-200' : 'bg-white text-gray-500 hover:bg-gray-50 border-gray-200';

                subNav = `
                <div class="flex justify-center gap-4 mb-4">
                    <button onclick="switchPersonalSub('learning')" class="relative px-6 py-2.5 rounded-full font-bold text-sm transition-all border flex items-center gap-2 ${styleLearn}">
                        <span>${txt.type_learning}</span>
                        ${learnLate > 0 ? `<div class="absolute -top-2 -right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white animate-pulse">${learnLate}</div>` : ''}
                        ${learnWeek > 0 ? `<div class="absolute -top-2 -left-1 bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white">${learnWeek}</div>` : ''}
                    </button>
                    <button onclick="switchPersonalSub('life')" class="relative px-6 py-2.5 rounded-full font-bold text-sm transition-all border flex items-center gap-2 ${styleLife}">
                        <span>${txt.type_life}</span>
                        ${lifeLate > 0 ? `<div class="absolute -top-2 -right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white animate-pulse">${lifeLate}</div>` : ''}
                        ${lifeWeek > 0 ? `<div class="absolute -top-2 -left-1 bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shadow-sm border-2 border-white">${lifeWeek}</div>` : ''}
                    </button>
                </div>`;

                if (personalSub === 'learning') {
                    extraButtons = `
                    <div class="flex justify-center mb-10">
                        <button onclick="openNoteEntry()" class="group relative relative w-full max-w-xs bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-5 rounded-3xl font-bold text-lg shadow-xl shadow-blue-500/30 hover:shadow-2xl hover:shadow-blue-500/50 transition-all duration-300 transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 overflow-hidden">
                            <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <i class="fa-solid fa-pen-to-square text-xl animate-bounce"></i>
                            <span>Take Smart Note</span>
                        </button>
                    </div>`;
                } else {
                    subNav += '<div class="mb-8"></div>'; 
                }
            }

            const total = filteredTasks.length;
            const done = filteredTasks.filter(t => t.status === 'done').length;
            const late = filteredTasks.filter(t => isLate(t)).length; 

            const now = new Date(); now.setHours(0,0,0,0);
            const nextWeek = new Date(now); nextWeek.setDate(now.getDate() + 7);

            const cntFocus = filteredTasks.filter(t => {
                if(t.status === 'done') return false;
                const d = new Date(t.date); d.setHours(0,0,0,0);
                return d <= now; 
            }).length;

            const cntWeek = filteredTasks.filter(t => {
                if(t.status === 'done') return false;
                const d = new Date(t.date); d.setHours(0,0,0,0);
                return d > now && d <= nextWeek;
            }).length;

            const cntLater = filteredTasks.filter(t => {
                if(t.status === 'done') return false;
                const d = new Date(t.date); d.setHours(0,0,0,0);
                return d > nextWeek;
            }).length;

            let theme;
            if (category === 'work') theme = {btn: 'bg-work-600 hover:bg-work-900', txt: 'text-work-600', border: 'border-work-200'};
            else if (category === 'home') theme = {btn: 'bg-home-600 hover:bg-home-900', txt: 'text-home-600', border: 'border-home-200'};
            else theme = {btn: 'bg-personal-600 hover:bg-personal-900', txt: 'text-personal-600', border: 'border-personal-200'};
            
            const badgeHTML = (count, color) => count > 0 ? `<span class="absolute top-1.5 right-2 w-4 h-4 ${color} text-white text-[9px] font-bold rounded-full flex items-center justify-center shadow-sm z-20 transition-transform">${count}</span>` : '';

            let mobileTabs = `
            <div class="relative bg-gray-200/50 p-1 rounded-2xl flex mb-6 md:hidden select-none">
                <div id="mobile-tab-indicator" class="absolute top-1 left-1 bottom-1 w-[calc(33.33%-0.33rem)] bg-white rounded-xl shadow-sm transition-all duration-300 ease-out transform translate-x-0 border border-gray-100"></div>
                
                <button onclick="switchMobileTab('today')" class="relative z-10 flex-1 py-3 text-[10px] font-bold text-gray-500 transition-colors mobile-tab-btn flex items-center justify-center gap-2 group" data-tab="today">
                    <span class="group-[.active-tab]:text-rose-600 transition-colors">Focus</span> 
                    <span class="bg-rose-500 text-white px-2 py-0.5 rounded-full text-[9px] min-w-[20px] text-center shadow-sm font-bold">${cntFocus}</span>
                </button>
                
                <button onclick="switchMobileTab('week')" class="relative z-10 flex-1 py-3 text-[10px] font-bold text-gray-500 transition-colors mobile-tab-btn flex items-center justify-center gap-2 group" data-tab="week">
                    <span class="group-[.active-tab]:text-indigo-600 transition-colors">Week</span> 
                    <span class="bg-indigo-500 text-white px-2 py-0.5 rounded-full text-[9px] min-w-[20px] text-center shadow-sm font-bold">${cntWeek}</span>
                </button>
                
                <button onclick="switchMobileTab('later')" class="relative z-10 flex-1 py-3 text-[10px] font-bold text-gray-500 transition-colors mobile-tab-btn flex items-center justify-center gap-2 group" data-tab="later">
                    <span class="group-[.active-tab]:text-slate-600 transition-colors">Later</span> 
                    <span class="bg-slate-500 text-white px-2 py-0.5 rounded-full text-[9px] min-w-[20px] text-center shadow-sm font-bold">${cntLater}</span>
                </button>
            </div>`;

            const gridClass = 'grid-cols-1 lg:grid-cols-3';
            
            let columnsHTML = `
                <div id="col-today" class="${currentMobileTab === 'today' ? 'block' : 'hidden'} md:block animate-fade">
                    ${renderColumn(txt.col_today, filteredTasks, 'today', theme.txt, txt)}
                </div>
                <div id="col-week" class="${currentMobileTab === 'week' ? 'block' : 'hidden'} md:block animate-fade">
                    ${renderColumn(txt.col_week, filteredTasks, 'week', theme.txt, txt)}
                </div>
                <div id="col-later" class="${currentMobileTab === 'later' ? 'block' : 'hidden'} md:block animate-fade">
                    ${renderColumn(txt.col_later, filteredTasks, 'later', theme.txt, txt)}
                </div>
            `;

            container.innerHTML = `
            <div class="animate-fade">
                ${subNav}
                ${extraButtons}
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <div class="flex gap-4 w-full md:w-auto overflow-x-auto pb-2 no-scrollbar">
                        <div class="bg-white px-6 py-4 rounded-2xl shadow-sm border border-gray-200 text-center flex-shrink-0 min-w-[100px]">
                            <span class="block text-2xl font-bold text-gray-800">${total}</span>
                            <span class="text-xs text-gray-500 font-bold">${txt.total}</span>
                        </div>
                        <div class="bg-white px-6 py-4 rounded-2xl shadow-sm border ${theme.border} text-center flex-shrink-0 min-w-[100px]">
                            <span class="block text-2xl font-bold text-green-600">${done}</span>
                            <span class="text-xs text-gray-500 font-bold">${txt.done}</span>
                        </div>
                        <div class="bg-white px-6 py-4 rounded-2xl shadow-sm border border-red-200 text-center flex-shrink-0 relative overflow-hidden min-w-[100px]">
                            <span class="block text-2xl font-bold text-red-600">${late}</span>
                            <span class="text-xs text-gray-500 font-bold">${txt.overdue}</span>
                        </div>
                    </div>
                    <button onclick="openModal('${category}')" type="button" class="${theme.btn} text-white py-4 px-8 rounded-2xl shadow-lg shadow-indigo-500/20 font-bold flex items-center justify-center gap-3 transition transform active:scale-95 w-full md:w-auto hover:-translate-y-1">
                        <i class="fa-solid fa-plus text-lg"></i><span>${txt.btn_new}</span>
                    </button>
                </div>
                
                ${mobileTabs}

                <div class="grid ${gridClass} gap-6 relative">
                    ${columnsHTML}
                </div>
            </div>`;
            
            setTimeout(() => {
                const btns = document.querySelectorAll('.mobile-tab-btn');
                btns.forEach(b => {
                    b.classList.remove('active-tab');
                    if(b.getAttribute('data-tab') === currentMobileTab) {
                        b.classList.add('active-tab');
                    }
                });
                
                const indicator = document.getElementById('mobile-tab-indicator');
                if(indicator) {
                    if(currentMobileTab === 'today') indicator.style.transform = 'translateX(0%)';
                    else if(currentMobileTab === 'week') indicator.style.transform = 'translateX(100%)';
                    else indicator.style.transform = 'translateX(200%)';
                }
            }, 50);
        }

        function renderColumn(title, list, filter, colorClass, txt) {
            const now = new Date(); 
            now.setHours(0,0,0,0); 

            const nextWeek = new Date(now); 
            nextWeek.setDate(now.getDate() + 7); 

            const items = list.filter(t => {
                if (t.status === 'done') return false;
                
                const d = new Date(t.date); 
                d.setHours(0,0,0,0); 

                if (filter === 'today') return d.getTime() <= now.getTime(); 
                if (filter === 'week') return d.getTime() > now.getTime() && d.getTime() <= nextWeek.getTime();
                return d.getTime() > nextWeek.getTime();
            });

            items.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            return `<div class="bg-white/60 backdrop-blur-md p-4 rounded-3xl min-h-[400px] border border-gray-200 flex flex-col"><h3 class="font-bold mb-4 ${colorClass} text-lg flex justify-between items-center px-2">${title} <span class="bg-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm text-gray-500 border border-gray-100">${items.length}</span></h3><div class="space-y-3 flex-1">${items.map(t => getTaskCardHTML(t, txt)).join('')}${items.length === 0 ? `<div class="h-full flex flex-col items-center justify-center text-gray-300 gap-2 min-h-[100px]"><i class="fa-solid fa-check-circle text-3xl opacity-20"></i><p class="text-xs font-bold">${txt.empty_col}</p></div>` : ''}</div></div>`;
        }
        
        function getTaskCardHTML(t, txt) {
            const isLate = isOverdue(t);
            let borderColor = 'border-l-gray-300'; 

            if (isLate) {
                borderColor = 'border-l-red-500 shadow-red-100 ring-1 ring-red-100'; 
            } else {
                if(t.category === 'work') borderColor = 'border-l-work-500';
                else if(t.category === 'home') borderColor = 'border-l-home-500';
                else if(t.category === 'personal') {
                    if (t.personalType === 'learning') borderColor = 'border-l-learning-500'; 
                    else borderColor = 'border-l-life-500'; 
                }
            }

            const dateObj = new Date(t.date);
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' }); 
            const fullDateDisplay = `${dayName}, ${t.date}`;

            let timeDisplay = '';
            if (t.timeFrom) {
                const start = t.timeFrom;
                const end = t.timeTo ? ` - ${t.timeTo}` : '';
                timeDisplay = `
                <div class="flex items-center gap-1.5 bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-gray-200">
                    <i class="fa-regular fa-clock text-gray-400"></i>
                    <span>${start}${end}</span>
                </div>`;
            }

            return `
            <div class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg border border-gray-100 border-l-[6px] ${borderColor} transition-all duration-300 group relative mb-4">
                
                <div class="flex justify-between items-start mb-4 gap-3">
                    <h4 class="font-bold text-gray-800 text-xl leading-relaxed w-full break-words">${t.title}</h4>
                    
                    <div class="flex gap-2 shrink-0 opacity-100 md:opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <button onclick="openRescheduleModal(${t.id}, 'single')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-colors shadow-sm" title="Reschedule">
                            <i class="fa-solid fa-calendar-days text-sm"></i>
                        </button>
                        <button onclick="completeTask(${t.id})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-green-50 text-green-600 hover:bg-green-600 hover:text-white transition-colors shadow-sm" title="Complete">
                            <i class="fa-solid fa-check text-sm"></i>
                        </button>
                        <button onclick="deleteTask(${t.id})" class="w-10 h-10 flex items-center justify-center rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-colors shadow-sm" title="Delete">
                            <i class="fa-solid fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col gap-3 pt-3 border-t border-gray-50">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="flex items-center gap-2 text-sm text-gray-500 font-medium bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">
                            <i class="fa-regular fa-calendar text-gray-400"></i>
                            <span class="${isLate ? 'text-red-600 font-bold' : ''}">${fullDateDisplay}</span>
                        </div>
                        
                        ${timeDisplay}
                    </div>

                    ${isLate ? `
                    <div class="mt-1">
                        <span class="flex items-center justify-center gap-1.5 bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm font-bold border border-red-100 w-full animate-pulse shadow-sm">
                            <i class="fa-solid fa-circle-exclamation"></i> OVERDUE - ${txt.overdue}
                        </span>
                    </div>` : ''}
                </div>
            </div>`;
        }

        function initCharts(txt) {
            const doneTotal = tasks.filter(t => t.status === 'done').length;
            const openTotal = tasks.filter(t => t.status !== 'done').length;
            const total = doneTotal + openTotal;
            const percentage = total === 0 ? 0 : Math.round((doneTotal / total) * 100);
            const textEl = document.getElementById('performance-text');
            if(textEl) {
                if(total === 0) textEl.innerHTML = `<span class="text-gray-400 text-sm">${txt.empty_perf}</span>`;
                else if(percentage >= 80) textEl.innerHTML = `<span class="text-green-600">${txt.perf_high}</span>`;
                else if(percentage >= 50) textEl.innerHTML = `<span class="text-yellow-600">${txt.perf_mid}</span>`;
                else textEl.innerHTML = `<span class="text-red-500">${txt.perf_low}</span>`;
            }
            const ctx1 = document.getElementById('chartCompletion');
            if(ctx1) { completionChart = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Done', 'Remaining'], datasets: [{ data: [doneTotal, openTotal], backgroundColor: ['#10b981', '#f3f4f6'], borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } }); }
            const days = []; const counts = []; 
            for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(d.toLocaleDateString('en-US', {weekday: 'short'})); const dateStr = d.toISOString().split('T')[0]; counts.push(tasks.filter(t => t.status === 'done' && t.date === dateStr).length); }
            const ctx2 = document.getElementById('chartWeekly');
            if(ctx2) { weeklyChart = new Chart(ctx2, { type: 'bar', data: { labels: days, datasets: [{ label: 'Done', data: counts, backgroundColor: '#4f46e5', borderRadius: 6, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { family: 'Poppins' } } } }, plugins: { legend: { display: false } } } }); }
        }

        function isOverdue(task) { 
            if(task.status === 'done') return false; 
            const now = new Date(); now.setHours(0,0,0,0);
            const d = new Date(task.date); d.setHours(0,0,0,0);
            return d < now; 
        }
        function countOverdue(cat) { return tasks.filter(t => t.category === cat && isOverdue(t)).length; }
        
        function saveTask() { 
            const title = document.getElementById('taskTitle').value; 
            const category = document.getElementById('taskCategory').value; 
            const date = document.getElementById('taskDate').value; 
            const timeFrom = document.getElementById('taskTimeFrom').value; 
            const timeTo = document.getElementById('taskTimeTo').value; 

            if(!title) return; 
            
            const loc = (category === 'work') ? workLocation : null; 
            const pType = (category === 'personal') ? personalSub : null; 

            tasks.push({ 
                id: Date.now(), 
                title, 
                category, 
                date, 
                timeFrom: timeFrom || null, 
                timeTo: timeTo || null, 
                status: 'open', 
                workLocation: loc, 
                personalType: pType, 
                createdAt: new Date().toISOString() 
            }); 
            saveToLocal(); closeModal(); renderContent(); 
        }

        function completeTask(id) { tasks = tasks.map(t => t.id === id ? {...t, status: 'done'} : t); addXP(10); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); saveToLocal(); renderContent(); }
        function deleteTask(id) { if(confirm(txt.confirm_del)) { tasks = tasks.filter(t => t.id !== id); saveToLocal(); renderContent(); } }
        function addXP(amount) { userStats.xp += amount; if(userStats.xp >= userStats.nextLevelXp) { userStats.level++; userStats.xp = 0; userStats.nextLevelXp = Math.floor(userStats.nextLevelXp * 1.5); alert(txt.level_up); } saveStats(); }
        function saveStats() { localStorage.setItem('lifeOS_stats_v7', JSON.stringify(userStats)); }
        function saveToLocal() { localStorage.setItem('lifeOS_tasks_v7', JSON.stringify(tasks)); }

        // --- CREATIVE HISTORY LOGIC ---
        function renderHistoryCreative(c, txt, searchQuery = '') { 
            if (historySubView === 'main') {
                c.innerHTML = `
                    <div class="animate-fade pb-20 pt-6 px-2 flex flex-col items-center justify-center h-full gap-6">
                        <div class="text-center mb-4">
                            <h3 class="text-3xl font-black text-gray-800 tracking-tight">${txt.hist_title}</h3>
                            <p class="text-gray-400 text-sm mt-2">Where time meets achievement.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
                            <button onclick="setHistoryView('work_select')" class="glass hover:bg-white p-8 rounded-[2rem] flex flex-col items-center gap-4 group transition-all duration-300 hover:scale-[1.02] shadow-sm hover:shadow-xl border border-white/40">
                                <div class="w-20 h-20 bg-gradient-to-br from-work-100 to-white rounded-full flex items-center justify-center group-hover:from-work-600 group-hover:to-work-500 transition-all shadow-inner">
                                    <i class="fa-solid fa-briefcase text-3xl text-work-600 group-hover:text-white transition-colors"></i>
                                </div>
                                <span class="font-bold text-xl text-gray-700 group-hover:text-work-600 transition-colors">${txt.hist_work_btn}</span>
                            </button>
                            <button onclick="setHistoryView('home')" class="glass hover:bg-white p-8 rounded-[2rem] flex flex-col items-center gap-4 group transition-all duration-300 hover:scale-[1.02] shadow-sm hover:shadow-xl border border-white/40">
                                <div class="w-20 h-20 bg-gradient-to-br from-home-100 to-white rounded-full flex items-center justify-center group-hover:from-home-600 group-hover:to-home-500 transition-all shadow-inner">
                                    <i class="fa-solid fa-house text-3xl text-home-600 group-hover:text-white transition-colors"></i>
                                </div>
                                <span class="font-bold text-xl text-gray-700 group-hover:text-home-600 transition-colors">${txt.hist_home_btn}</span>
                            </button>
                            <button onclick="setHistoryView('personal_select')" class="glass hover:bg-white p-8 rounded-[2rem] flex flex-col items-center gap-4 group transition-all duration-300 hover:scale-[1.02] shadow-sm hover:shadow-xl border border-white/40">
                                <div class="w-20 h-20 bg-gradient-to-br from-personal-100 to-white rounded-full flex items-center justify-center group-hover:from-personal-600 group-hover:to-personal-500 transition-all shadow-inner">
                                    <i class="fa-solid fa-user text-3xl text-personal-600 group-hover:text-white transition-colors"></i>
                                </div>
                                <span class="font-bold text-xl text-gray-700 group-hover:text-personal-600 transition-colors">${txt.hist_personal_btn}</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            else if (historySubView === 'work_select') {
                c.innerHTML = `
                    <div class="animate-fade pb-20 pt-10 px-2 flex flex-col items-center justify-center h-full gap-8">
                        <button onclick="setHistoryView('main')" class="bg-white/50 px-4 py-2 rounded-full text-gray-500 hover:text-gray-800 font-bold flex items-center gap-2 transition hover:bg-white"><i class="fa-solid fa-arrow-left"></i> ${txt.hist_back}</button>
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-work-600">${txt.hist_work_btn}</h3>
                            <p class="text-gray-400 text-sm">Select location</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-6 w-full max-w-lg justify-center">
                            <button onclick="setHistoryView('work_eg')" class="glass p-8 rounded-3xl flex flex-col items-center gap-4 hover:scale-105 transition hover:shadow-xl flex-1">
                                <span class="text-6xl drop-shadow-md">ðŸ‡ªðŸ‡¬</span>
                                <span class="font-bold text-xl text-gray-700">${txt.loc_egypt}</span>
                            </button>
                            <button onclick="setHistoryView('work_ksa')" class="glass p-8 rounded-3xl flex flex-col items-center gap-4 hover:scale-105 transition hover:shadow-xl flex-1">
                                <span class="text-6xl drop-shadow-md">ðŸ‡¸ðŸ‡¦</span>
                                <span class="font-bold text-xl text-gray-700">${txt.loc_ksa}</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            else if (historySubView === 'personal_select') {
                c.innerHTML = `
                    <div class="animate-fade pb-20 pt-10 px-2 flex flex-col items-center justify-center h-full gap-8">
                        <button onclick="setHistoryView('main')" class="bg-white/50 px-4 py-2 rounded-full text-gray-500 hover:text-gray-800 font-bold flex items-center gap-2 transition hover:bg-white"><i class="fa-solid fa-arrow-left"></i> ${txt.hist_back}</button>
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-personal-600">${txt.hist_personal_btn}</h3>
                            <p class="text-gray-400 text-sm">Select Category</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-6 w-full max-w-lg justify-center">
                            <button onclick="setHistoryView('personal_learning')" class="glass p-8 rounded-3xl flex flex-col items-center gap-4 hover:scale-105 transition hover:shadow-xl flex-1 group">
                                <div class="w-16 h-16 bg-learning-100 rounded-full flex items-center justify-center text-3xl group-hover:bg-learning-600 group-hover:text-white transition-colors">ðŸ“š</div>
                                <span class="font-bold text-xl text-gray-700">${txt.type_learning}</span>
                            </button>
                            <button onclick="setHistoryView('personal_life')" class="glass p-8 rounded-3xl flex flex-col items-center gap-4 hover:scale-105 transition hover:shadow-xl flex-1 group">
                                <div class="w-16 h-16 bg-life-100 rounded-full flex items-center justify-center text-3xl group-hover:bg-life-600 group-hover:text-white transition-colors">ðŸŒ±</div>
                                <span class="font-bold text-xl text-gray-700">${txt.type_life}</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            else {
                let baseList = []; 
                let title = '';
                let backView = 'main';
                let themeColor = 'text-gray-600';

                if (historySubView === 'home') {
                    baseList = tasks.filter(t => t.status === 'done' && t.category === 'home');
                    title = txt.hist_home_btn;
                    backView = 'main';
                    themeColor = 'text-home-600';
                } else if (historySubView === 'personal_learning') {
                    baseList = tasks.filter(t => t.status === 'done' && t.category === 'personal' && t.personalType === 'learning');
                    title = txt.type_learning;
                    backView = 'personal_select';
                    themeColor = 'text-learning-600';
                } else if (historySubView === 'personal_life') {
                    baseList = tasks.filter(t => t.status === 'done' && t.category === 'personal' && (t.personalType === 'life' || !t.personalType));
                    title = txt.type_life;
                    backView = 'personal_select';
                    themeColor = 'text-life-600';
                } else if (historySubView === 'work_eg') {
                    baseList = tasks.filter(t => t.status === 'done' && t.category === 'work' && t.workLocation === 'egypt');
                    title = txt.loc_egypt;
                    backView = 'work_select';
                    themeColor = 'text-work-600';
                } else if (historySubView === 'work_ksa') {
                    baseList = tasks.filter(t => t.status === 'done' && t.category === 'work' && t.workLocation === 'ksa');
                    title = txt.loc_ksa;
                    backView = 'work_select';
                    themeColor = 'text-work-600';
                }

                const generatedMonths = [];
                for (let m = 1; m <= 12; m++) {
                    const monthStr = String(m).padStart(2, '0');
                    generatedMonths.push(`${historyYearFilter}-${monthStr}`); 
                }
               
                let displayList = [...baseList];
                if (historyMonthFilter !== 'all') {
                    displayList = displayList.filter(t => t.date && t.date.startsWith(historyMonthFilter));
                }
                
                displayList.sort((a,b) => new Date(b.date) - new Date(a.date));

                const formatMonthShort = (mStr) => {
                     const [y, m] = mStr.split('-');
                     const d = new Date(y, m - 1);
                     return d.toLocaleDateString('en-US', {month:'short'});
                };
                const formatYear = (mStr) => mStr.split('-')[0];

                c.innerHTML = `
                    <div class="animate-fade pb-24">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="setHistoryView('${backView}')" class="bg-white/60 px-4 py-2 rounded-full text-gray-500 hover:text-gray-800 font-bold flex items-center gap-2 transition hover:bg-white shadow-sm"><i class="fa-solid fa-arrow-left"></i> ${txt.hist_back}</button>
                            <h3 class="font-black text-2xl ${themeColor}">${title}</h3>
                        </div>

                         <div class="glass p-6 rounded-3xl mb-8 flex items-center justify-between relative overflow-hidden animate-slide-up">
                            <div class="absolute -right-10 -top-10 w-32 h-32 bg-gray-100 rounded-full opacity-20"></div>
                            <div>
                                <p class="text-sm text-gray-500 font-bold mb-1">${txt.hist_total} ${historyMonthFilter === 'all' ? 'All Time' : historyMonthFilter}</p>
                                <h2 class="text-4xl font-black text-gray-800">${displayList.length} <span class="text-base font-medium text-gray-400">${txt.month_completed}</span></h2>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-xl shadow-sm">ðŸ†</div>
                        </div>

                        <div class="flex items-center justify-center gap-6 mb-4">
                            <button onclick="changeHistoryYear(-1)" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-600 hover:bg-gray-100 transition"><i class="fa-solid fa-chevron-left"></i></button>
                            <span class="text-2xl font-black text-gray-800 tracking-tight">${historyYearFilter}</span>
                            <button onclick="changeHistoryYear(1)" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-600 hover:bg-gray-100 transition"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>

                        <div class="relative group mb-8">
                             <button onclick="scrollMonths('left')" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 shadow-md w-10 h-10 rounded-full hidden md:flex items-center justify-center text-gray-600 hover:text-brand-900 transition hover:scale-110 -ml-4 border border-gray-100"><i class="fa-solid fa-chevron-left"></i></button>
                             
                             <div id="monthScroller" class="flex gap-3 overflow-x-auto pb-4 no-scrollbar snap-x px-2 scroll-smooth">
                                <button onclick="setHistoryMonth('all')" class="snap-center flex-shrink-0 px-6 py-3 rounded-2xl font-bold transition-all border-2 ${historyMonthFilter === 'all' ? 'bg-gray-800 text-white border-gray-800 scale-105 shadow-lg' : 'bg-white text-gray-400 border-transparent hover:bg-gray-100'}">
                                    ${txt.hist_all_months}
                                </button>
                                ${generatedMonths.map(m => `
                                    <button onclick="setHistoryMonth('${m}')" class="snap-center flex-shrink-0 flex flex-col items-center justify-center w-20 h-20 rounded-2xl transition-all border-2 ${historyMonthFilter === m ? 'bg-white border-brand-900 text-brand-900 scale-105 shadow-lg' : 'bg-white/50 border-transparent text-gray-400 hover:bg-white'}">
                                        <span class="text-xs font-bold opacity-60">${formatYear(m)}</span>
                                        <span class="text-lg font-black">${formatMonthShort(m)}</span>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <button onclick="scrollMonths('right')" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 shadow-md w-10 h-10 rounded-full hidden md:flex items-center justify-center text-gray-600 hover:text-brand-900 transition hover:scale-110 -mr-4 border border-gray-100"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>

                        <div class="relative w-full mb-8">
                            <input type="text" id="historySearchInput" oninput="filterHistoryLive(this.value)" placeholder="${txt.hist_search}" class="w-full pl-12 pr-4 py-4 rounded-2xl border-none bg-white shadow-sm focus:ring-2 focus:ring-brand-900 outline-none transition text-gray-600" value="${searchQuery}">
                            <i class="fa-solid fa-search absolute left-5 top-5 text-gray-300"></i>
                        </div>

                        <div class="space-y-0 relative pl-4 md:pl-8">
                            <div id="historyNoResults" class="hidden flex flex-col items-center justify-center py-8 text-gray-400">
                                <i class="fa-solid fa-ghost text-2xl mb-2"></i>
                                <span class="text-sm">No items match your search.</span>
                            </div>
                            ${displayList.length === 0 ? `
                                <div class="flex flex-col items-center justify-center py-12 text-gray-300 gap-4 animate-fade">
                                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-4xl mb-2 opacity-50">ðŸ‘»</div>
                                    <p class="text-base font-bold text-gray-400">${txt.hist_empty}</p>
                                </div>
                            ` : displayList.map((t, index) => `
                                <div class="timeline-item relative pl-8 pb-8 animate-slide-up" style="animation-delay: ${index * 0.05}s">
                                    <div class="timeline-line absolute left-0 top-0 bottom-0 w-8 flex flex-col items-center">
                                        <div class="w-3 h-3 bg-gray-300 rounded-full z-10 mt-6 ring-4 ring-gray-50"></div>
                                    </div>
                                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between gap-4 hover:shadow-md transition-shadow group">
                                        <div>
                                            <h4 class="font-bold text-gray-800 text-lg line-through decoration-gray-300 decoration-2">${t.title}</h4>
                                            <p class="text-xs text-gray-400 font-bold mt-1 flex items-center gap-2"><i class="fa-regular fa-calendar"></i> ${t.date}</p>
                                        </div>
                                        <div class="w-10 h-10 rounded-full bg-green-50 text-green-500 flex items-center justify-center text-lg shadow-sm group-hover:bg-green-500 group-hover:text-white transition-colors">
                                            <i class="fa-solid fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function renderSettings(c, txt) { c.innerHTML = `<div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 max-w-2xl mx-auto"><h3 class="font-bold mb-6 text-xl">âš™ï¸ ${txt.set_title}</h3><div class="space-y-4"><div class="p-4 bg-red-50 rounded-xl border border-red-100"><h4 class="font-bold text-red-800 mb-2">${txt.set_danger}</h4><button onclick="if(confirm('${txt.confirm_reset}')){localStorage.clear();location.reload()}" class="w-full text-white bg-red-600 hover:bg-red-700 px-4 py-3 rounded-xl font-bold transition shadow-lg shadow-red-200">${txt.btn_reset}</button></div></div></div>`; }

        function checkDailyBriefing() {
            const today = new Date().toISOString().split('T')[0];
            const todaysTasks = tasks.filter(t => t.date === today && t.status !== 'done');
            if (todaysTasks.length > 0) {
                const hour = new Date().getHours();
                const greeting = hour < 12 ? txt.brief_morning : txt.brief_evening;
                // You can implement a custom modal for briefing here if desired
            }
        }
        
        function checkOverduePopup() {
            const overdueTasks = tasks.filter(t => isOverdue(t));
            const notifDotDesktop = document.getElementById('notif-dot-desktop');
            const notifDotMobile = document.getElementById('notif-dot-mobile');
            const bellIcons = document.querySelectorAll('.bell-icon');
            
            if (overdueTasks.length > 0) {
                if(notifDotDesktop) notifDotDesktop.classList.remove('hidden');
                if(notifDotMobile) notifDotMobile.classList.remove('hidden');
                bellIcons.forEach(icon => icon.classList.add('bell-ringing'));
                document.getElementById('overdueList').innerHTML = overdueTasks.map(t => {
                    let icon = 'â“';
                    if(t.category === 'work') icon = 'ðŸ’¼';
                    else if(t.category === 'home') icon = 'ðŸ ';
                    else if(t.category === 'personal') icon = 'ðŸ‘¤';
                    return `<div class="flex justify-between items-center bg-gray-50 border border-gray-200 p-3 rounded-lg mb-2 shadow-sm"><div class="flex items-center gap-3"><span class="text-xl">${icon}</span><div><p class="font-bold text-sm text-gray-800">${t.title}</p><p class="text-[10px] text-red-500 font-bold">${t.date}</p></div></div><div class="flex gap-2"><button onclick="openRescheduleModal(${t.id}, 'single')" class="bg-blue-100 text-blue-600 hover:bg-blue-200 w-8 h-8 rounded-lg flex items-center justify-center transition"><i class="fa-solid fa-calendar-days text-sm"></i></button><button onclick="deleteTask(${t.id});checkOverduePopup()" class="bg-red-100 text-red-500 hover:bg-red-200 w-8 h-8 rounded-lg flex items-center justify-center transition"><i class="fa-solid fa-trash text-sm"></i></button></div></div>`
                }).join('');
                document.getElementById('warningModal').classList.remove('hidden');
            } else { 
                if(notifDotDesktop) notifDotDesktop.classList.add('hidden');
                if(notifDotMobile) notifDotMobile.classList.add('hidden');
                bellIcons.forEach(icon => icon.classList.remove('bell-ringing'));
                document.getElementById('warningModal').classList.add('hidden'); 
            }
        }
        function openBatchRescheduleModal() { document.getElementById('warningModal').classList.add('hidden'); openRescheduleModal(null, 'batch'); }
        function openRescheduleModal(id, mode) { 
            taskToRescheduleId = id; 
            rescheduleMode = mode; 
            document.getElementById('rescheduleModal').classList.remove('hidden'); 
            rescheduleDatePicker.setDate(new Date()); 
            
            rescheduleTimePickerFrom.clear();
            rescheduleTimePickerTo.clear();

            if(mode === 'single' && id) {
                const task = tasks.find(t => t.id === id);
                if(task) {
                   if(task.timeFrom) rescheduleTimePickerFrom.setDate(task.timeFrom);
                   if(task.timeTo) rescheduleTimePickerTo.setDate(task.timeTo);
                }
            }
        }
        function closeRescheduleModal() { document.getElementById('rescheduleModal').classList.add('hidden'); taskToRescheduleId = null; if (rescheduleMode === 'batch' || rescheduleMode === 'single') checkOverduePopup(); }
        function confirmReschedule() { 
            const newDate = document.getElementById('newRescheduleDate').value; 
            const newTimeFrom = document.getElementById('rescheduleTimeFrom').value;
            const newTimeTo = document.getElementById('rescheduleTimeTo').value;

            if(!newDate) return; 
            
            if (rescheduleMode === 'batch') { 
                tasks = tasks.map(t => {
                    if(isOverdue(t)) {
                        return {
                            ...t, 
                            date: newDate,
                            timeFrom: newTimeFrom || t.timeFrom,
                            timeTo: newTimeTo || t.timeTo
                        };
                    }
                    return t;
                }); 
                alert(txt.reschedule_done); 
            } else if (taskToRescheduleId) { 
                tasks = tasks.map(t => t.id === taskToRescheduleId ? {
                    ...t, 
                    date: newDate,
                    timeFrom: newTimeFrom || null, 
                    timeTo: newTimeTo || null
                } : t); 
            } 
            
            saveToLocal(); 
            closeRescheduleModal(); 
            renderContent(); 
            checkOverduePopup(); 
        }
        
        function closeModal() { 
            document.getElementById('taskModal').classList.add('hidden'); 
            document.getElementById('taskTitle').value = ''; 
            if(datePicker) datePicker.clear();
            if(isTimeEnabled) toggleTimeInput(); 
        }
        
        function clearTime(id, e) {
            e.stopPropagation();
            if(id === 'taskTimeTo' && timePickerTo) timePickerTo.clear();
            if(id === 'rescheduleTimeTo' && rescheduleTimePickerTo) rescheduleTimePickerTo.clear();
        }
        
        function openModal(category) { 
            document.getElementById('taskModal').classList.remove('hidden'); 
            if(datePicker) datePicker.setDate(new Date()); 
            document.getElementById('taskCategory').value = category; 
            
            const badge = document.getElementById('subCategoryBadge'); 
            const badgeText = document.getElementById('badgeText'); 
            
            if (category === 'work') { 
                badge.classList.remove('hidden'); 
                if (workLocation === 'egypt') { 
                    badgeText.innerText = txt.loc_egypt; 
                    badge.className = "mb-4 p-3 bg-red-50 rounded-lg text-center border border-red-100 text-red-700"; 
                } else { 
                    badgeText.innerText = txt.loc_ksa; 
                    badge.className = "mb-4 p-3 bg-green-50 rounded-lg text-center border border-green-100 text-green-700"; 
                } 
            } else if (category === 'personal') {
                badge.classList.remove('hidden');
                if (personalSub === 'learning') {
                    badgeText.innerText = txt.type_learning;
                    badge.className = "mb-4 p-3 bg-blue-50 rounded-lg text-center border border-blue-100 text-blue-700";
                } else {
                    badgeText.innerText = txt.type_life;
                    badge.className = "mb-4 p-3 bg-pink-50 rounded-lg text-center border border-pink-100 text-pink-700";
                }
            } else { 
                badge.classList.add('hidden'); 
            } 
            
            const header = document.getElementById('modalHeader'); 
            const btn = document.getElementById('saveBtn'); 
            let color = 'bg-gray-600';
            if (category === 'work') color = 'bg-work-600'; 
            else if (category === 'home') color = 'bg-home-600'; 
            else if (category === 'personal') color = 'bg-personal-600';
            
            header.className = `p-4 md:p-5 flex justify-between items-center text-white ${color}`; 
            btn.className = `px-6 py-2 text-white rounded-lg hover:opacity-90 font-bold transition ${color}`; 
        }

        switchView('landing'); 
    </script>
</body>
</html>
